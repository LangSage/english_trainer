<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1,
                 user-scalable=no, viewport-fit=cover">
  <title>Number Trainer ‚Äî 7 Levels</title>

  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">

  <style>
    :root{
      --bg: #050815;
      --card: #0c1224;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,.25);
      --accent2: #3b82f6;
      --border: #1c2742;
      --text: #e5ecff;
      --muted: #8c95b0;
      --danger: #f97373;
      --warning: #eab308;
    }

    *{ box-sizing:border-box; }

    html,body{
      margin:0; padding:0;
      height:100%; width:100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 800px at -10% -20%, #1e293b, transparent 50%),
                  radial-gradient(1200px 800px at 110% -20%, #0f766e, transparent 50%),
                  var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
      overscroll-behavior:none;
      touch-action:manipulation;
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .app{
      width:100%;
      max-width:600px;
      min-height:100vh;
      padding:8px 10px 16px;
      display:flex;
      flex-direction:column;
    }

    .app-card{
      flex:1;
      display:flex;
      flex-direction:column;
      border-radius:18px;
      background:
        radial-gradient(900px 600px at -10% -20%, rgba(96,165,250,.18), transparent 40%),
        radial-gradient(900px 600px at 110% -10%, rgba(45,212,191,.16), transparent 40%),
        var(--card);
      box-shadow:0 16px 60px rgba(0,0,0,.65);
      padding:10px 12px 14px;
    }

    .hidden{ display:none !important; }

    .app-header{
      padding:4px 2px 8px;
      border-bottom:1px solid var(--border);
      margin-bottom:8px;
    }

    .app-title{
      font-size:1.3rem;
      font-weight:700;
      letter-spacing:.03em;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:2px 9px;
      border-radius:999px;
      background:#050816;
      border:1px solid #1e293b;
      font-size:.75rem;
      color:var(--muted);
      white-space:nowrap;
    }

    .pill .dot{
      width:6px; height:6px;
      border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .global-progress-wrap{
      margin-top:6px;
    }

    .progress{
      background:#050816;
      border-radius:999px;
      border:1px solid #1e2238;
      height:12px;
      overflow:hidden;
    }
    .progress-bar{
      background:linear-gradient(90deg,var(--accent),#4ade80);
    }

    .screen{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:6px 2px 4px;
    }

    /* LEVEL LIST */
    .levels-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
    }

    .level-card{
      border-radius:14px;
      border:1px solid #141a30;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.96));
      color:inherit;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      text-align:left;
      width:100%;
      box-shadow:0 10px 25px rgba(0,0,0,.45);
      transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .level-card:active{
      transform:scale(.98) translateY(1px);
      box-shadow:0 8px 16px rgba(0,0,0,.6);
    }
    .level-card:hover{
      border-color:#1d2a4b;
    }

    .level-name{
      font-size:.98rem;
      font-weight:700;
    }
    .level-desc{
      font-size:.78rem;
      color:var(--muted);
    }
    .level-chip{
      font-size:.7rem;
      color:var(--muted);
    }

    .stars{
      display:flex;
      gap:2px;
      justify-content:flex-end;
    }
    .star{
      font-size:.85rem;
      filter:drop-shadow(0 0 4px rgba(0,0,0,.6));
      transform-origin:center;
    }
    .star.full{
      color:#facc15;
    }
    .star.empty{
      color:#1e293b;
    }
    .stars-big .star{
      font-size:1.6rem;
    }

    .time-label{
      font-size:.75rem;
      color:var(--muted);
      text-align:right;
    }

    /* QUIZ */
    .quiz-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .btn-back{
      font-size:.85rem;
      color:var(--muted);
      padding:4px 0;
    }

    .timer-pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:2px 10px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:8px;
      max-width:max-content;
    }

    .question-card{
      border-radius:16px;
      border:1px solid #141a30;
      background:radial-gradient(800px 400px at 0% -40%, rgba(59,130,246,.25), transparent),
                 radial-gradient(800px 400px at 120% -10%, rgba(34,197,94,.23), transparent),
                 #020617;
      padding:12px 12px 12px;
      margin-bottom:10px;
      text-align:center;
    }
    .question-label{
      font-size:.8rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .question-main{
      font-size:1.8rem;
      font-weight:800;
      margin-top:4px;
      text-shadow:0 4px 18px rgba(0,0,0,.75);
    }
    .question-sub{
      font-size:.78rem;
      color:var(--muted);
      margin-top:2px;
    }

    .btn-sound{
      margin-top:8px;
      font-size:.85rem;
      padding:4px 12px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
    }
    .btn-sound:active{
      transform:scale(.97);
    }

    .choices-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:10px;
    }
    .choice-btn{
      border-radius:14px;
      border:1px solid #1f2937;
      background:#020617;
      padding:10px 6px;
      font-size:1.35rem;
      font-weight:700;
      color:var(--text);
      box-shadow:0 8px 20px rgba(0,0,0,.6);
      transition:transform .06s ease, box-shadow .08s ease, border-color .08s ease, background .08s ease;
    }
    .choice-btn:active{
      transform:scale(.97) translateY(1px);
      box-shadow:0 5px 14px rgba(0,0,0,.7);
    }
    .choice-btn.correct{
      border-color:var(--accent);
      background:rgba(34,197,94,.08);
    }
    .choice-btn.wrong{
      border-color:var(--danger);
      background:rgba(220,38,38,.07);
    }

    #typedWrap input{
      text-align:center;
      font-size:1.3rem;
      letter-spacing:.06em;
    }

    #feedbackArea{
      min-height:22px;
    }

    .badge-small{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      padding:2px 8px;
      border-radius:999px;
      font-size:.7rem;
      background:#020617;
      border:1px solid #111827;
      color:var(--muted);
    }

    /* RESULT */
    .result-wrap{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:16px 12px 8px;
    }

    .result-title{
      font-size:1.3rem;
      font-weight:700;
      margin-bottom:4px;
    }

    .result-sub{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .result-time{
      font-size:1rem;
      margin-bottom:2px;
    }
    .result-extra{
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:12px;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--accent2),#22c55e);
      border:none;
    }
    .btn-primary:active{
      transform:scale(.98) translateY(1px);
    }

    /* MEGA ANIMATION */
    .mega{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#1d283a,#020617 60%);
      z-index:9999;
    }
    .mega.hidden{ display:none !important; }

    .mega-inner{
      position:relative;
      padding:22px 18px 16px;
      border-radius:26px;
      background:
        radial-gradient(700px 400px at 10% -40%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(800px 450px at 120% 0%, rgba(34,197,94,.35), transparent 60%),
        #020617;
      border:1px solid #1f2937;
      text-align:center;
      box-shadow:0 0 40px rgba(34,197,94,.45);
      animation:megaPop .7s cubic-bezier(.22,1.15,.4,1);
      overflow:hidden;
    }

    .mega-title{
      font-size:1.5rem;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-bottom:4px;
      text-shadow:0 0 20px rgba(34,197,94,.8);
    }
    .mega-sub{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .mega-stars{
      display:flex;
      justify-content:center;
      gap:4px;
      margin-bottom:10px;
    }
    .mega-stars .star{
      font-size:1.5rem;
      color:#facc15;
      animation:starPulse 1.2s ease-in-out infinite alternate;
    }

    .confetti{
      position:absolute;
      width:7px;
      height:14px;
      border-radius:3px;
      background:#facc15;
      opacity:.9;
      animation:confettiFall linear infinite;
      pointer-events:none;
    }

    @keyframes megaPop{
      0%{ transform:scale(.7) translateY(40px); opacity:0;}
      60%{ transform:scale(1.04) translateY(0); opacity:1;}
      100%{ transform:scale(1) translateY(0); opacity:1;}
    }

    @keyframes starPulse{
      from{ transform:scale(1) translateY(0); filter:drop-shadow(0 0 8px rgba(250,204,21,.6)); }
      to{ transform:scale(1.1) translateY(-3px); filter:drop-shadow(0 0 14px rgba(250,204,21,1)); }
    }

    @keyframes confettiFall{
      0%{ transform:translate3d(0,-120vh,0) rotateZ(0deg);}
      100%{ transform:translate3d(0,120vh,0) rotateZ(360deg);}
    }

    /* small screens */
    @media (max-width: 480px){
      .question-main{ font-size:1.6rem; }
      .choice-btn{ font-size:1.25rem; padding:9px 4px;}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-card">

    <!-- HEADER -->
    <header class="app-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="app-title">Number Trainer</div>
          <div class="text-muted" style="font-size:.7rem;">7 levels ¬∑ listen & choose / type numbers</div>
        </div>
        <div>
          <span class="pill">
            <span class="dot"></span>
            <span id="headerLevelText">Menu</span>
          </span>
        </div>
      </div>

      <div class="global-progress-wrap mt-2">
        <div class="d-flex justify-content-between align-items-center mb-1" style="font-size:.75rem;">
          <span class="text-muted">Overall progress</span>
          <span id="globalProgressLabel" class="text-muted">0%</span>
        </div>
        <div class="progress">
          <div id="globalProgressBar" class="progress-bar" style="width:0%;"></div>
        </div>
      </div>
    </header>

    <!-- MAIN SCREENS -->
    <main class="screen">

      <!-- MENU -->
      <section id="screen-menu">
        <p class="mb-2" style="font-size:.8rem;color:var(--muted);">
          Listen to the number and <strong>tap the correct digits</strong> or <strong>type what you hear</strong>.
          Try to get <span style="color:#facc15;">5‚òÖ</span> on every level!
        </p>

        <div class="levels-list" id="levelsList">
          <!-- Level cards are static HTML; JS fills stars & times -->
          <button class="level-card" data-level-id="L1">
            <div>
              <div class="level-name">Level 1</div>
              <div class="level-desc">Choose numbers: 1‚Äì2 digits ¬∑ 16 items</div>
              <div class="level-chip">Mode: multiple choice</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L1"></div>
              <div class="time-label">Best: <span data-time-for="L1">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L2">
            <div>
              <div class="level-name">Level 2</div>
              <div class="level-desc">Choose numbers: 2 digits ¬∑ 25 items</div>
              <div class="level-chip">Mode: multiple choice</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L2"></div>
              <div class="time-label">Best: <span data-time-for="L2">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L3">
            <div>
              <div class="level-name">Level 3</div>
              <div class="level-desc">Choose numbers: 3 digits ¬∑ 20 items</div>
              <div class="level-chip">Mode: multiple choice</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L3"></div>
              <div class="time-label">Best: <span data-time-for="L3">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L4">
            <div>
              <div class="level-name">Level 4</div>
              <div class="level-desc">Choose numbers: 4 &amp; 5 digits ¬∑ 20 items</div>
              <div class="level-chip">Mode: multiple choice</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L4"></div>
              <div class="time-label">Best: <span data-time-for="L4">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L5">
            <div>
              <div class="level-name">Level 5</div>
              <div class="level-desc">Write numbers: 2 digits ¬∑ 25 items</div>
              <div class="level-chip">Mode: type what you hear</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L5"></div>
              <div class="time-label">Best: <span data-time-for="L5">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L6">
            <div>
              <div class="level-name">Level 6</div>
              <div class="level-desc">Write numbers: 3 digits ¬∑ 20 items</div>
              <div class="level-chip">Mode: type what you hear</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L6"></div>
              <div class="time-label">Best: <span data-time-for="L6">‚Äî</span></div>
            </div>
          </button>

          <button class="level-card" data-level-id="L7">
            <div>
              <div class="level-name">Level 7</div>
              <div class="level-desc">Write numbers: 4 &amp; 5 digits ¬∑ 20 items</div>
              <div class="level-chip">Mode: type what you hear</div>
            </div>
            <div class="text-end">
              <div class="stars" data-stars-for="L7"></div>
              <div class="time-label">Best: <span data-time-for="L7">‚Äî</span></div>
            </div>
          </button>
        </div>

        <div id="audioWarning" class="mt-3" style="font-size:.75rem;color:var(--muted);">
          üîà Audio manifest not loaded yet. Trainer will still work, but without sound.
          After you generate <code>audio/manifest.js</code> the numbers will play automatically.
        </div>
      </section>

      <!-- QUIZ -->
      <section id="screen-quiz" class="hidden">
        <div class="quiz-header">
          <button id="btnBackFromQuiz" class="btn btn-link btn-back">&larr; Menu</button>
          <div class="text-end" style="font-size:.78rem;">
            <div id="quizLevelName" class="text-muted">Level</div>
            <div><span id="quizProgressLabel">0 / 0</span></div>
          </div>
        </div>

        <div class="timer-pill">
          ‚è± <span id="quizTimer">00:00</span>
        </div>

        <div class="question-card">
          <div class="question-label">Listen</div>
          <div id="quizPrompt" class="question-main">?</div>
          <div id="quizDigitsInfo" class="question-sub">Number</div>
          <button id="btnPlay" class="btn-sound">üîä Play</button>
        </div>

        <div id="mcqWrap">
          <div id="choicesBox" class="choices-grid"></div>
        </div>

        <div id="typedWrap" class="hidden">
          <label for="typedAnswer" class="form-label mb-1" style="font-size:.75rem;color:var(--muted);">
            Type the number you hear:
          </label>
          <input id="typedAnswer" type="text" class="form-control form-control-lg"
                 inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
          <div class="d-flex gap-2 mt-2">
            <button id="btnCheck" class="btn btn-success flex-grow-1">Check</button>
            <button id="btnClear" class="btn btn-outline-light">Clear</button>
          </div>
        </div>

        <div id="feedbackArea" class="mt-2 text-center"></div>

        <div class="d-flex justify-content-between align-items-center mt-1" style="font-size:.78rem;">
          <div>
            <span class="badge-small">
              ‚úÖ Correct: <span id="quizCorrectCount">0</span> / <span id="quizTotalCount">0</span>
            </span>
          </div>
          <button id="btnNext" class="btn btn-primary btn-sm px-3" disabled>Next ‚ûú</button>
        </div>
      </section>

      <!-- RESULT -->
      <section id="screen-result" class="hidden">
        <div class="result-wrap">
          <div class="result-title" id="resultLevelTitle">Level done!</div>
          <div class="result-sub" id="resultSummary"></div>

          <div id="resultStars" class="stars stars-big mb-2"></div>

          <div class="result-time">
            Time: <span id="resultTime">00:00</span>
          </div>
          <div class="result-extra">
            Correct on <span id="resultCorrect">0</span> items ¬∑
            Attempts: <span id="resultAttempts">0</span>
          </div>

          <div class="mb-2" style="font-size:.8rem;color:var(--muted);">
            Faster = more stars. Try to beat your best time!
          </div>

          <button id="btnResultMenu" class="btn btn-primary w-100 mb-2">Back to menu</button>
          <button id="btnResultRetry" class="btn btn-outline-light w-100">Retry level</button>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- MEGA WIN OVERLAY -->
<div id="megaWin" class="mega hidden">
  <div class="mega-inner">
    <div class="mega-title">MASTER OF NUMBERS</div>
    <div class="mega-sub">You got 5‚òÖ on every level. Insane speed! üöÄ</div>

    <div class="mega-stars">
      <span class="star full">‚òÖ</span>
      <span class="star full">‚òÖ</span>
      <span class="star full">‚òÖ</span>
      <span class="star full">‚òÖ</span>
      <span class="star full">‚òÖ</span>
    </div>

    <button id="btnMegaClose" class="btn btn-light w-100 mt-1">OK, back to practice</button>
  </div>
</div>

<!-- Shared audio player -->
<audio id="audioPlayer" preload="auto"></audio>

<!-- Optional: generated by generate_audio.py -->
<script src="audio/manifest.js"></script>

<script>
(function(){
  // --------- Levels config ---------
  const LEVELS = [
    // Level 1: choose numbers 1‚Äì2 digits, 16 items total
    { id:'L1', label:'Level 1',
      desc:'Choose 16 numbers (1‚Äì2 digits)',
      mode:'mcq',
      spec:[ {d:1,c:8}, {d:2,c:8} ]
    },
    // Level 2: choose 2-digit numbers, 25 items
    { id:'L2', label:'Level 2',
      desc:'Choose 25 numbers (2 digits)',
      mode:'mcq',
      spec:[ {d:2,c:25} ]
    },
    // Level 3: choose 3-digit numbers, 20 items
    { id:'L3', label:'Level 3',
      desc:'Choose 20 numbers (3 digits)',
      mode:'mcq',
      spec:[ {d:3,c:20} ]
    },
    // Level 4: choose 4- & 5-digit numbers, 10 + 10
    { id:'L4', label:'Level 4',
      desc:'Choose 10 √ó 4-digit + 10 √ó 5-digit',
      mode:'mcq',
      spec:[ {d:4,c:10}, {d:5,c:10} ]
    },
    // Level 5: write 2-digit numbers, 25 items
    { id:'L5', label:'Level 5',
      desc:'Write 25 numbers (2 digits)',
      mode:'type',
      spec:[ {d:2,c:25} ]
    },
    // Level 6: write 3-digit numbers, 20 items
    { id:'L6', label:'Level 6',
      desc:'Write 20 numbers (3 digits)',
      mode:'type',
      spec:[ {d:3,c:20} ]
    },
    // Level 7: write what you hear, 4- & 5-digit numbers, 10 + 10
    { id:'L7', label:'Level 7',
      desc:'Write 10 √ó 4-digit + 10 √ó 5-digit',
      mode:'type',
      spec:[ {d:4,c:10}, {d:5,c:10} ]
    }
  ];

  const LEVEL_MAP = {};
  LEVELS.forEach(l => LEVEL_MAP[l.id] = l);

  // --------- Helpers ---------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function rnd(min,max){
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  function digitsRange(d){
    if(d === 1) return [0,9];
    const min = Math.pow(10,d-1);
    const max = Math.pow(10,d)-1;
    return [min,max];
  }

  function formatSeconds(sec){
    if(!Number.isFinite(sec) || sec < 0) sec = 0;
    const s = Math.floor(sec);
    const m = Math.floor(s/60);
    const r = s % 60;
    return String(m).padStart(2,'0') + ':' + String(r).padStart(2,'0');
  }

  function renderStars(container, count, big){
    container.innerHTML = '';
    const n = Math.max(0, Math.min(5, count || 0));
    for(let i=1;i<=5;i++){
      const span = document.createElement('span');
      span.className = 'star ' + (i<=n ? 'full' : 'empty');
      if(big) span.classList.add('big');
      span.textContent = '‚òÖ';
      if(big){
        span.style.animationDelay = (i*0.08) + 's';
      }
      container.appendChild(span);
    }
  }

  // Time->stars: based only on how fast
  function computeStars(level, seconds, totalItems){
    if(!totalItems || !Number.isFinite(seconds) || seconds <= 0) return 1;

    const maxDigits = level.spec.reduce((m,s)=>Math.max(m,s.d), 1);
    let perItem;
    if(level.mode === 'mcq'){
      perItem = 4.0;          // 4 seconds per MCQ item baseline
    }else{
      perItem = (maxDigits <= 3) ? 6.0 : 8.0; // slower for longer numbers
    }
    const goal = perItem * totalItems;
    const ratio = seconds / goal;

    if(ratio <= 0.6) return 5;
    if(ratio <= 0.8) return 4;
    if(ratio <= 1.1) return 3;
    if(ratio <= 1.4) return 2;
    return 1;
  }

  // --------- Local storage ---------
  const STORE_KEY = 'number_trainer_v2';
  let store;
  try{
    const raw = localStorage.getItem(STORE_KEY);
    const parsed = raw ? JSON.parse(raw) : {};
    store = {
      bestStars: parsed.bestStars || {},
      bestTimes: parsed.bestTimes || {},
      totalRuns: parsed.totalRuns || {},
      megaShown: !!parsed.megaShown
    };
  }catch(e){
    store = { bestStars:{}, bestTimes:{}, totalRuns:{}, megaShown:false };
  }
  function saveStore(){
    try{
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }catch(e){}
  }

  // --------- Manifest / audio ---------
  let manifest = Array.isArray(window.MANIFEST) ? window.MANIFEST.slice() : [];
  const audioWarningEl = $('#audioWarning');
  function hasAudio(){
    return Array.isArray(manifest) && manifest.length>0;
  }
  if(hasAudio()){
    if(audioWarningEl) audioWarningEl.classList.add('hidden');
  }

  function findManifestItem(n){
    if(!manifest) return null;
    return manifest.find(x => x && x.number === n) || null;
  }

  // --------- DOM refs ---------
  const screenMenu   = $('#screen-menu');
  const screenQuiz   = $('#screen-quiz');
  const screenResult = $('#screen-result');

  const headerLevelText = $('#headerLevelText');
  const globalProgressBar = $('#globalProgressBar');
  const globalProgressLabel = $('#globalProgressLabel');

  const quizLevelName = $('#quizLevelName');
  const quizProgressLabel = $('#quizProgressLabel');
  const quizTimer = $('#quizTimer');
  const quizPrompt = $('#quizPrompt');
  const quizDigitsInfo = $('#quizDigitsInfo');
  const quizCorrectCount = $('#quizCorrectCount');
  const quizTotalCount = $('#quizTotalCount');

  const mcqWrap = $('#mcqWrap');
  const choicesBox = $('#choicesBox');
  const typedWrap = $('#typedWrap');
  const typedAnswer = $('#typedAnswer');
  const feedbackArea = $('#feedbackArea');

  const btnPlay = $('#btnPlay');
  const btnNext = $('#btnNext');
  const btnBackFromQuiz = $('#btnBackFromQuiz');
  const btnCheck = $('#btnCheck');
  const btnClear = $('#btnClear');

  const resultLevelTitle = $('#resultLevelTitle');
  const resultSummary = $('#resultSummary');
  const resultStars = $('#resultStars');
  const resultTime = $('#resultTime');
  const resultCorrect = $('#resultCorrect');
  const resultAttempts = $('#resultAttempts');
  const btnResultMenu = $('#btnResultMenu');
  const btnResultRetry = $('#btnResultRetry');

  const audioEl = $('#audioPlayer');

  const megaWin = $('#megaWin');
  const btnMegaClose = $('#btnMegaClose');

  // --------- Confetti for mega win ---------
  function buildConfetti(){
    if(!megaWin) return;
    const colors = ['#facc15','#4ade80','#38bdf8','#fb7185','#a855f7'];
    for(let i=0;i<80;i++){
      const s = document.createElement('span');
      s.className = 'confetti';
      s.style.left = (Math.random()*100) + '%';
      s.style.top = (-20 - Math.random()*40) + 'vh';
      s.style.background = colors[i % colors.length];
      const dur = 4 + Math.random()*3;
      const delay = (-Math.random()*5);
      s.style.animationDuration = dur + 's';
      s.style.animationDelay = delay + 's';
      megaWin.appendChild(s);
    }
  }
  buildConfetti();

  // --------- Screen switching ---------
  function showScreen(name){
    screenMenu.classList.add('hidden');
    screenQuiz.classList.add('hidden');
    screenResult.classList.add('hidden');

    if(name === 'menu'){
      screenMenu.classList.remove('hidden');
      headerLevelText.textContent = 'Menu';
    }else if(name === 'quiz'){
      screenQuiz.classList.remove('hidden');
    }else if(name === 'result'){
      screenResult.classList.remove('hidden');
    }
  }

  // --------- State of current run ---------
  let current = null;
  let timerId = null;

  function buildQueue(level){
    const byDigits = {};
    if(Array.isArray(manifest)){
      manifest.forEach(item=>{
        if(!item) return;
        const d = Number(item.digits || String(item.number||'').length || 0);
        if(!byDigits[d]) byDigits[d] = [];
        byDigits[d].push(item.number);
      });
    }

    const queue = [];
    const missing = [];

    level.spec.forEach(part=>{
      const d = part.d;
      const count = part.c;
      const pool = (byDigits[d] || []).slice();
      shuffle(pool);

      if(pool.length >= count){
        queue.push(...pool.slice(0,count));
      }else{
        if(pool.length > 0){
          queue.push(...pool);
        }
        missing.push({digits:d, need:count, have:pool.length});
        // fill with random numbers (no audio yet) so level still works
        const [min,max] = digitsRange(d);
        const set = new Set(pool);
        while(set.size < count){
          set.add(rnd(min,max));
        }
        set.forEach(n => {
          if(!queue.includes(n)) queue.push(n);
        });
      }
    });

    shuffle(queue);
    return { queue, missing };
  }

  function updateGlobalProgress(){
    let sumStars = 0;
    let maxStars = LEVELS.length * 5;

    LEVELS.forEach(l=>{
      const s = (store.bestStars && store.bestStars[l.id]) || 0;
      sumStars += s;
      const starsEl = document.querySelector('[data-stars-for="'+l.id+'"]');
      const timeEl = document.querySelector('[data-time-for="'+l.id+'"]');
      if(starsEl){
        renderStars(starsEl, s, false);
      }
      if(timeEl){
        const t = store.bestTimes && store.bestTimes[l.id];
        timeEl.textContent = (typeof t === 'number' && t>0) ? formatSeconds(t) : '‚Äî';
      }
    });

    const pct = maxStars ? Math.round((sumStars/maxStars)*100) : 0;
    globalProgressBar.style.width = pct + '%';
    globalProgressLabel.textContent = pct + '%';
  }

  function updateQuizHeader(){
    if(!current) return;
    const level = current.level;
    const done = current.completed.size;
    const total = current.total;
    quizLevelName.textContent = level.label;
    quizProgressLabel.textContent = done + ' / ' + total;
    quizCorrectCount.textContent = done;
    quizTotalCount.textContent = total;
    headerLevelText.textContent = level.label;
  }

  function updateTimer(){
    if(!current) return;
    const now = performance.now();
    const sec = (now - current.startTime)/1000;
    quizTimer.textContent = formatSeconds(sec);
  }

  function playCurrentAudio(){
    if(!current) return;
    const n = current.currentNumber;
    const item = findManifestItem(n);
    if(!item || !item.file){
      // no audio yet
      return;
    }
    try{
      audioEl.src = item.file;
      audioEl.currentTime = 0;
      const p = audioEl.play();
      if(p && p.catch){ p.catch(()=>{}); }
    }catch(e){}
  }

  function describeDigits(list){
    const uniq = Array.from(new Set(list)).sort((a,b)=>a-b);
    if(uniq.length === 1){
      const d = uniq[0];
      return d === 1 ? '1-digit number' : d + '-digit number';
    }else{
      return uniq[0] + '‚Äì' + uniq[uniq.length-1] + ' digit number';
    }
  }

  function renderQuestion(){
    if(!current) return;
    const st = current;
    if(st.queue.length === 0){
      return finishLevel();
    }

    const n = st.queue[0];
    st.currentNumber = n;
    st.questionAnswered = false;

    const digits = String(Math.abs(n)).length;
    const digitsList = st.level.spec.map(x=>x.d);
    const txtDigits = describeDigits(digitsList);

    quizPrompt.textContent = 'üîä';
    quizDigitsInfo.textContent = txtDigits;
    feedbackArea.textContent = '';

    // mode
    const typedMode = (st.level.mode === 'type');
    mcqWrap.classList.toggle('hidden', typedMode);
    typedWrap.classList.toggle('hidden', !typedMode);
    btnNext.disabled = true;

    if(typedMode){
      typedAnswer.value = '';
      typedAnswer.classList.remove('is-invalid','is-valid');
      setTimeout(()=>typedAnswer.focus(), 80);
    }

    // build MCQ choices
    if(!typedMode){
      choicesBox.innerHTML = '';
      const opts = buildOptions(n);
      st.currentOptions = opts;
      opts.forEach(val=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'choice-btn';
        btn.textContent = String(val);
        btn.addEventListener('click', () => handleMCQClick(btn,val));
        choicesBox.appendChild(btn);
      });
    }

    // auto play audio if available
    playCurrentAudio();
    updateQuizHeader();
  }

  function buildOptions(correct){
    const digits = String(Math.abs(correct)).length;

    const fromManifest = manifest
      .filter(x => x && Number(x.digits || String(x.number||'').length || 0) === digits)
      .map(x => x.number);

    const set = new Set([correct]);
    if(fromManifest.length > 0){
      while(set.size < 4 && fromManifest.length > 0){
        const n = fromManifest[rnd(0, fromManifest.length-1)];
        set.add(n);
      }
    }
    while(set.size < 4){
      const [min,max] = digitsRange(digits);
      set.add(rnd(min,max));
    }

    const arr = Array.from(set);
    return shuffle(arr);
  }

  function handleMCQClick(btn, picked){
    if(!current || current.questionAnswered) return;
    const st = current;
    const correct = st.queue[0];

    st.attempts++;

    $$('.choice-btn').forEach(b => { b.disabled = true; });

    if(picked === correct){
      btn.classList.add('correct');
      if(!st.completed.has(correct)){
        st.completed.add(correct);
      }
      feedbackArea.innerHTML = '<span style="color:var(--accent);">‚úÖ Correct!</span>';
      st.queue.shift(); // remove
    }else{
      btn.classList.add('wrong');
      feedbackArea.innerHTML = '<span style="color:var(--danger);">‚ùå Wrong, this number will come back later.</span>';
      const q = st.queue.shift();
      st.queue.push(q);
    }

    st.questionAnswered = true;
    btnNext.disabled = false;
    updateQuizHeader();
  }

  function handleCheckTyped(){
    if(!current) return;
    const st = current;

    // if already checked and user presses again -> act like "Next"
    if(st.questionAnswered){
      btnNext.click();
      return;
    }

    const raw = typedAnswer.value.trim();
    const n = st.queue[0];

    const val = Number(raw);
    if(!raw || !Number.isFinite(val)){
      typedAnswer.classList.add('is-invalid');
      feedbackArea.innerHTML = '<span style="color:var(--warning);">‚ö†Ô∏è Type digits only.</span>';
      return;
    }

    st.attempts++;

    if(val === n){
      typedAnswer.classList.remove('is-invalid');
      typedAnswer.classList.add('is-valid');
      feedbackArea.innerHTML = '<span style="color:var(--accent);">‚úÖ Correct!</span>';
      if(!st.completed.has(n)){
        st.completed.add(n);
      }
      st.queue.shift();
    }else{
      typedAnswer.classList.remove('is-valid');
      typedAnswer.classList.add('is-invalid');
      feedbackArea.innerHTML = '<span style="color:var(--danger);">‚ùå Wrong, this number will repeat later.</span>';
      const q = st.queue.shift();
      st.queue.push(q);
    }

    st.questionAnswered = true;
    btnNext.disabled = false;
    updateQuizHeader();
  }

  function finishLevel(){
    if(!current) return;
    const st = current;

    if(timerId){
      clearInterval(timerId);
      timerId = null;
    }

    const now = performance.now();
    const elapsedSec = (now - st.startTime)/1000;
    const lvl = st.level;
    const totalItems = st.total;
    const stars = computeStars(lvl, elapsedSec, totalItems);

    // update store
    const prevBest = (store.bestTimes && store.bestTimes[lvl.id]) || null;
    if(prevBest === null || elapsedSec < prevBest){
      store.bestTimes[lvl.id] = elapsedSec;
    }
    const prevStars = (store.bestStars && store.bestStars[lvl.id]) || 0;
    if(stars > prevStars){
      store.bestStars[lvl.id] = stars;
    }
    if(!store.totalRuns[lvl.id]) store.totalRuns[lvl.id] = 0;
    store.totalRuns[lvl.id]++;
    saveStore();

    // update UI
    updateGlobalProgress();

    resultLevelTitle.textContent = lvl.label + ' complete!';
    resultSummary.textContent = lvl.desc;
    renderStars(resultStars, stars, true);

    resultTime.textContent = formatSeconds(elapsedSec);
    resultCorrect.textContent = st.completed.size;
    resultAttempts.textContent = st.attempts;

    showScreen('result');

    // check mega win
    checkMegaWin();
  }

  function checkMegaWin(){
    const allFive = LEVELS.every(l => (store.bestStars && store.bestStars[l.id] || 0) >= 5);
    if(allFive && !store.megaShown){
      store.megaShown = true;
      saveStore();
      if(megaWin) megaWin.classList.remove('hidden');
    }
  }

  // --------- Starting a level ---------
  function startLevel(id){
    const level = LEVEL_MAP[id];
    if(!level) return;

    const {queue, missing} = buildQueue(level);
    if(!queue.length){
      alert('No numbers available for this level. Check your audio manifest.');
      return;
    }

    current = {
      level,
      queue: queue.slice(),
      completed: new Set(),
      total: queue.length,
      attempts: 0,
      currentNumber: null,
      questionAnswered: false,
      startTime: performance.now()
    };

    if(timerId){
      clearInterval(timerId);
    }
    timerId = setInterval(updateTimer, 250);
    quizTimer.textContent = '00:00';

    // small warning if audio missing for some digit groups
    if(missing && missing.length && audioWarningEl){
      audioWarningEl.textContent = '‚ö†Ô∏è Audio missing for some numbers, but level will still work.';
      audioWarningEl.classList.remove('hidden');
    }else if(hasAudio() && audioWarningEl){
      audioWarningEl.classList.add('hidden');
    }

    showScreen('quiz');
    renderQuestion();
  }

  // --------- Event listeners ---------
  // Level cards
  $$('#levelsList .level-card').forEach(btn=>{
    const id = btn.getAttribute('data-level-id');
    btn.addEventListener('click', ()=> startLevel(id));
  });

  btnBackFromQuiz.addEventListener('click', ()=>{
    if(timerId){
      clearInterval(timerId);
      timerId = null;
    }
    current = null;
    showScreen('menu');
    headerLevelText.textContent = 'Menu';
  });

  btnPlay.addEventListener('click', ()=>{
    playCurrentAudio();
  });

  btnNext.addEventListener('click', ()=>{
    if(!current) return;
    renderQuestion();
  });

  btnCheck.addEventListener('click', handleCheckTyped);
  btnClear.addEventListener('click', ()=>{
    typedAnswer.value = '';
    typedAnswer.classList.remove('is-invalid','is-valid');
    typedAnswer.focus();
  });

  typedAnswer.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      handleCheckTyped();
    }
  });

  btnResultMenu.addEventListener('click', ()=>{
    showScreen('menu');
    headerLevelText.textContent = 'Menu';
  });

  btnResultRetry.addEventListener('click', ()=>{
    if(!current){
      // retry last level from store? just go back to menu
      showScreen('menu');
      headerLevelText.textContent = 'Menu';
      return;
    }
  });

  btnMegaClose.addEventListener('click', ()=>{
    megaWin.classList.add('hidden');
  });

  // --------- Init ---------
  updateGlobalProgress();
  showScreen('menu');
})();
</script>
</body>
</html>
