<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- PHONE: fill screen, no zoom -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1,
                 user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Number Trainer ‚Äî Levels (Static, Cached, Auto Submit + Level field)</title>

  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">

  <style>
    :root{
      font-size:18px; /* balanced phone size */
      --bg:#0b0f16; --card:#0f1523; --ink:#eef2f8; --muted:#a8b3c7; --border:#1e2a3f;
      --ok:#22c55e; --bad:#ef4444; --g1:#5aa8ff; --g2:#7bffca; --num:#ffd400;
    }
    *{ -webkit-tap-highlight-color: transparent; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--ink);
      -webkit-text-size-adjust:100%; overscroll-behavior:none; touch-action:manipulation; user-select:none;
    }

    .app{height:100svh; width:100%; display:flex; flex-direction:column;}
    .card-app{
      flex:1; display:flex; flex-direction:column;
      background:
        radial-gradient(900px 600px at -10% -20%, rgba(90,168,255,.12), transparent 40%),
        radial-gradient(900px 600px at 110% -10%, rgba(123,255,202,.10), transparent 40%),
        var(--card);
    }

    /* Header + Tabs */
    .hero{padding:10px 12px calc(8px + env(safe-area-inset-top)); border-bottom:1px solid var(--border);}
    .badge-pill{display:inline-flex; align-items:center; gap:.45rem; padding:.3rem .65rem; border-radius:999px; font-size:.9rem; background:#0e1422; border:1px solid #203049; color:#d1d9e7;}
    .progress-wrap{height:12px; border-radius:999px; overflow:hidden; background:#0c1220; border:1px solid var(--border);}
    .progress-bar{height:100%; background:linear-gradient(90deg,var(--g1),var(--g2)); transition:width .25s ease;}
    .tabs{display:flex; gap:6px; margin-top:8px;}
    .tab{flex:1; text-align:center; padding:.6rem .5rem; border-radius:12px; border:1px solid var(--border); background:#0e1626; color:#cfe1ff; font-weight:600;}
    .tab.active{background:#142038; border-color:#2a4170;}

    .screen{flex:1; display:flex; flex-direction:column; padding:12px; gap:10px; min-height:0;}
    .hidden{display:none !important;}
    .muted{color:var(--muted);}

    .intro h1{font-size:1.2rem;margin:0}
    .name-row{display:flex; gap:8px; align-items:center;}
    .name-input{flex:1; background:#0e1626; border:1px solid var(--border); color:var(--ink); border-radius:12px; padding:.8rem .9rem; font-size:1.05rem;}
    .btn{border-radius:14px;}
    .btn-start{padding:.85rem 1rem;}

    .quiz-grid{flex:1; display:grid; grid-template-rows:auto 1fr auto; gap:10px; min-height:0;}
    .playbar{display:flex; align-items:center; gap:8px;}
    .btn-play{width:68px;height:68px;border-radius:50%;background:#0f1729;color:#e8f1ff;border:2px solid #22324f;display:flex;align-items:center;justify-content:center;font-size:1.15rem;}
    .btn-fat{padding:.8rem 1rem;}

    .choices{
      min-height:0; display:grid; grid-template-columns:1fr 1fr; grid-auto-rows:1fr; gap:10px;
    }
    .choice{
      display:flex; align-items:center; justify-content:center;
      border:2px solid #21304a; background:#0d1423; border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      color:var(--num); text-shadow:0 1px 2px rgba(0,0,0,.85);
      font-weight:900; letter-spacing:.4px; text-align:center;
      font-size:clamp(1.9rem, 9vw, 2.8rem);
      padding:8px; transition:transform .06s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .choice:active{transform:scale(.985)}
    .choice.correct{border-color:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18) inset;}
    .choice.wrong{border-color:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18) inset;}

    .cta{position:sticky; bottom:0; padding-top:6px; background:linear-gradient(180deg,transparent,rgba(11,15,22,.95)); padding-bottom:calc(6px + env(safe-area-inset-bottom));}
    .btn-next{width:100%; padding:1rem 1rem; font-size:1.1rem;}

    .toastbox{font-size:.98rem; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0e1626;}
    .warn{color:#ffd466}

    .row-compact{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .btn-mini{padding:.4rem .6rem; font-size:.85rem; border-radius:10px;}
  </style>
</head>
<body>
  <div class="app">
    <div class="card-app">

      <!-- HEADER -->
      <div class="hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="row-compact">
            <span class="badge-pill" id="pillLevel">Level 1</span>
            <span class="badge-pill" id="pillCount">Done 0 / 40</span>
            <span class="badge-pill" id="pillWarn" class="hidden" style="display:none">‚ö†Ô∏è Missing audio</span>
          </div>
          <div class="text-end" style="font-size:.95rem">
            <div class="muted">Unique Correct: <span id="liveScore">0</span></div>
          </div>
        </div>
        <div class="mt-2 progress-wrap"><div id="bar" class="progress-bar" style="width:0%"></div></div>
        <div class="tabs">
          <button class="tab active" id="tabL1">Level 1</button>
          <button class="tab" id="tabL2">Level 2</button>
          <button class="tab" id="tabL3">Level 3</button>
        </div>
      </div>

      <!-- BODY -->
      <div class="screen" id="screen">
        <!-- Start / Resume -->
        <div id="paneStart">
          <div class="intro">
            <h1 id="title">Number Trainer ‚Äî <span id="titleLevel">Level 1</span></h1>
            <p class="muted mb-2" id="levelDesc"></p>
            <div class="name-row mb-2">
              <input id="nameInput" class="name-input" type="text" autocomplete="name" placeholder="Your full name" required>
              <button class="btn btn-primary btn-start" id="btnStart" disabled>Start</button>
            </div>
            <div class="row-compact">
              <button class="btn btn-outline-light btn-mini" id="btnResume" style="display:none">Resume</button>
              <button class="btn btn-outline-warning btn-mini" id="btnReset" style="display:none">Reset Level</button>
            </div>
            <div class="muted small mt-2" id="availInfo"></div>
          </div>
        </div>

        <!-- Quiz -->
        <div id="paneQuiz" class="hidden">
          <div class="quiz-grid">
            <div class="playbar">
              <button class="btn-play" id="btnPlay" aria-label="Play audio">‚ñ∂Ô∏è</button>
              <button class="btn btn-outline-light btn-fat" id="btnReplay" disabled>‚ü≤ Replay</button>
              <span class="muted ms-auto">Queue: <span id="queueLeft">0</span></span>
            </div>

            <div class="choices" id="choices"></div>

            <div class="cta">
              <div id="feedback" class="mb-2"></div>
              <button class="btn btn-primary btn-next" id="btnNext" disabled>Next ‚ûú</button>
            </div>
          </div>
          <audio id="player" preload="auto"></audio>
        </div>

        <!-- Done -->
        <div id="paneDone" class="hidden text-center">
          <h2 class="h5">Finished üéâ</h2>
          <p class="muted">Attempts: <strong><span id="attemptsTotal">0</span></strong> ‚Äî Score: <strong><span id="scorePct">0</span>%</strong></p>
          <div class="small muted" id="breakdown"></div>
          <div class="mt-2">
            <button class="btn btn-success w-100" id="btnAgain">Do Again</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Manifest generated by Python (must define window.MANIFEST) -->
  <script src="audio/manifest.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>

  <script>
    /* --------- NO ZOOM --------- */
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    window.addEventListener('wheel', e => { if (e.ctrlKey) e.preventDefault(); }, { passive:false });

    /* --------- CONFIG: Google Form (with Level field) --------- */
    const FORM_URL   = "https://docs.google.com/forms/d/e/1FAIpQLSf_bAuHT1RQI_4gnRWyYrveE9XDccSaddRkxLaFSz9YLziTMQ/formResponse";
    const FIELD_NAME = "entry.1894172247"; // name
    const FIELD_SCORE= "entry.18818728";   // score (number)
    const FIELD_IP   = "entry.361885690";  // IP
    const FIELD_LEVEL= "entry.64560435";   // Level_1 / Level_2 / Level_3 (or *_wip for checkpoint)

    /* --------- Level specs (target counts) --------- */
    const LEVELS = {
      L1: { label:"Level 1", key:"Level_1", desc:"30 √ó two-digit + 10 √ó one-digit", spec:[{d:2,c:30},{d:1,c:10}] },
      L2: { label:"Level 2", key:"Level_2", desc:"10 √ó two-digit + 30 √ó three-digit", spec:[{d:2,c:10},{d:3,c:30}] },
      L3: { label:"Level 3", key:"Level_3", desc:"Mix: 15 √ó three-digit + 15 √ó four-digit + 10 √ó five-digit", spec:[{d:3,c:15},{d:4,c:15},{d:5,c:10}] }
    };

    /* --------- Helpers --------- */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const shuffle = (a)=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
    const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    /* --------- UI Refs --------- */
    const UI = {
      tabL1: $('#tabL1'), tabL2: $('#tabL2'), tabL3: $('#tabL3'),
      pillLevel: $('#pillLevel'), pillCount: $('#pillCount'), pillWarn: $('#pillWarn'),
      bar: $('#bar'), liveScore: $('#liveScore'),

      paneStart: $('#paneStart'), paneQuiz: $('#paneQuiz'), paneDone: $('#paneDone'),
      titleLevel: $('#titleLevel'), levelDesc: $('#levelDesc'), availInfo: $('#availInfo'),
      nameInput: $('#nameInput'), btnStart: $('#btnStart'), btnResume: $('#btnResume'), btnReset: $('#btnReset'),

      btnPlay: $('#btnPlay'), btnReplay: $('#btnReplay'), btnNext: $('#btnNext'),
      player: $('#player'), choices: $('#choices'), feedback: $('#feedback'), queueLeft: $('#queueLeft'),

      attemptsTotal: $('#attemptsTotal'), breakdown: $('#breakdown'), btnAgain: $('#btnAgain'), scorePct: $('#scorePct')
    };

    /* --------- Profile (name, ip) --------- */
    const STORE_KEY = "numtrainer_v3";
    const profile = { name:"", ip:"unknown" };

    (function loadProfile(){
      try{
        const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
        if(saved?.profile?.name) profile.name = saved.profile.name;
        if(saved?.profile?.ip) profile.ip = saved.profile.ip;
        UI.nameInput.value = profile.name || "";
        UI.btnStart.disabled = UI.nameInput.value.trim().length < 2;
      }catch(_){}
      fetch("https://api.ipify.org?format=json",{cache:"no-store"}).then(r=>r.json()).then(d=>{
        profile.ip = d.ip; saveAll();
      }).catch(()=>{});
    })();

    UI.nameInput.addEventListener("input", ()=>{
      UI.btnStart.disabled = UI.nameInput.value.trim().length < 2;
    });

    /* --------- Per-level state --------- */
    let cur = { id:"L1", total:0 };
    const state = {
      L1: mkEmpty(), L2: mkEmpty(), L3: mkEmpty()
    };
    function mkEmpty(){
      return { queue:[], completed:[], correctByDigits:{}, attempts:0, submitted:false, total:0, spec:[], _lastSubmittedAttempts:0 };
    }

    function saveAll(){
      const blob = { profile, state };
      localStorage.setItem(STORE_KEY, JSON.stringify(blob));
    }
    function loadAll(){
      try{
        const saved = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
        if(saved?.state){
          for(const k of ["L1","L2","L3"]){
            if(saved.state[k]){
              state[k] = Object.assign(mkEmpty(), saved.state[k]);
              state[k].queue = Array.isArray(state[k].queue)? state[k].queue : [];
              state[k].completed = Array.isArray(state[k].completed)? state[k].completed : [];
              state[k].correctByDigits = state[k].correctByDigits || {};
              state[k].attempts = Number(state[k].attempts||0);
              state[k].submitted = !!state[k].submitted;
              state[k].total = Number(state[k].total||0);
              state[k].spec = Array.isArray(state[k].spec)? state[k].spec : [];
              state[k]._lastSubmittedAttempts = Number(state[k]._lastSubmittedAttempts||0);
            }
          }
        }
      }catch(_){}
    }
    loadAll();

    function setTab(activeId){
      // auto-checkpoint submit BEFORE switching away
      maybeSubmitCheckpoint(cur.id);

      cur.id = activeId;
      $$('.tab').forEach(t=>t.classList.remove('active'));
      ({L1:UI.tabL1, L2:UI.tabL2, L3:UI.tabL3}[activeId]).classList.add('active');

      UI.pillLevel.textContent = LEVELS[cur.id].label;
      UI.titleLevel.textContent = LEVELS[cur.id].label;
      UI.levelDesc.textContent = LEVELS[cur.id].desc;

      const st = state[cur.id];
      const haveProgress = st.queue.length>0 || st.completed.length>0;
      UI.btnResume.style.display = haveProgress ? 'inline-block' : 'none';
      UI.btnReset.style.display  = haveProgress ? 'inline-block' : 'none';
      UI.btnStart.textContent = haveProgress ? 'Start New' : 'Start';

      updateHeader();
      showPane('start');
      inspectAvailability();
    }

    function showPane(name){
      UI.paneStart.classList.toggle('hidden', name!=='start');
      UI.paneQuiz.classList.toggle('hidden',  name!=='quiz');
      UI.paneDone.classList.toggle('hidden',  name!=='done');
    }

    function updateHeader(){
      const st = state[cur.id];
      UI.pillCount.textContent = `Done ${st.completed.length} / ${st.total||0}`;
      UI.liveScore.textContent = st.completed.length;
      UI.queueLeft.textContent = st.queue.length;
      const p = st.total? Math.round((st.completed.length/st.total)*100) : 0;
      UI.bar.style.width = p+'%';
    }

    function warnMissing(show){ UI.pillWarn.style.display = show ? '' : 'none'; }

    /* --------- Build queue for level from MANIFEST --------- */
    function selectPool(spec){
      const byD = {};
      (Array.isArray(MANIFEST)? MANIFEST : []).forEach(item=>{
        (byD[item.digits] ||= []).push(item);
      });
      const availability = spec.map(s => ({ d:s.d, need:s.c, have:(byD[s.d]||[]).length }));
      let missing = false;
      const queue = [];
      for(const a of availability){
        const pool = byD[a.d] || [];
        if(a.have < a.need){ missing = true; }
        const pick = Math.min(a.need, pool.length);
        const take = shuffle(pool.slice()).slice(0, pick);
        queue.push(...take);
      }
      warnMissing(missing);
      return { queue: shuffle(queue), intendedTotal: spec.reduce((s,x)=>s+x.c,0), availability };
    }

    function inspectAvailability(){
      if(!Array.isArray(window.MANIFEST)){ UI.availInfo.textContent = 'Manifest missing. Run generator.'; return; }
      const sel = selectPool(LEVELS[cur.id].spec);
      const lines = sel.availability.map(a=>`${a.d}-digit: need ${a.need}, have ${a.have}`);
      UI.availInfo.innerHTML = `<span class="${sel.availability.some(a=>a.have<a.need)?'warn':''}">Audio availability ‚Äî ${lines.join(' ¬∑ ')}</span>`;
    }

    /* --------- Start / Resume / Reset --------- */
    UI.btnStart.addEventListener('click', ()=>{
      profile.name = UI.nameInput.value.trim();
      if(profile.name.length<2) return;
      saveAll();

      const sel = selectPool(LEVELS[cur.id].spec);
      const st = state[cur.id] = mkEmpty();
      st.queue = sel.queue.map(x=>x.number);
      st.total = sel.intendedTotal;
      st.spec  = LEVELS[cur.id].spec;
      saveAll();

      beginQuiz();
    });

    UI.btnResume.addEventListener('click', ()=>{
      profile.name = UI.nameInput.value.trim();
      saveAll();
      if(state[cur.id].queue.length===0 && state[cur.id].completed.length === (state[cur.id].total||0)){
        renderDone();
        showPane('done');
      }else{
        beginQuiz(true);
      }
    });

    UI.btnReset.addEventListener('click', ()=>{
      state[cur.id] = mkEmpty();
      saveAll();
      setTab(cur.id);
    });

    /* --------- Quiz flow --------- */
    UI.btnPlay.addEventListener('click', ()=>{ UI.player.currentTime=0; UI.player.play().catch(()=>{}); UI.btnReplay.disabled=false; });
    UI.btnReplay.addEventListener('click', ()=>{ UI.player.currentTime=0; UI.player.play().catch(()=>{}); });
    UI.btnNext.addEventListener('click', ()=> renderQuestion());

    function beginQuiz(resume=false){
      showPane('quiz');
      if(!resume) UI.feedback.innerHTML = '';
      renderQuestion();
    }

    function renderQuestion(){
      const st = state[cur.id];
      if(st.queue.length===0){ renderDone(); return; }

      const n = st.queue[0];
      const item = (MANIFEST||[]).find(x=>x.number===n);
      const digits = String(n).length;

      UI.pillLevel.textContent = LEVELS[cur.id].label;
      UI.pillCount.textContent = `Done ${st.completed.length} / ${st.total}`;
      UI.queueLeft.textContent = st.queue.length;
      UI.bar.style.width = (st.total? Math.round((st.completed.length/st.total)*100) : 0) + '%';
      UI.feedback.innerHTML = '';
      UI.btnNext.disabled = true; UI.btnReplay.disabled = true;

      UI.player.src = item?.file || '';
      const pr = UI.player.play(); if(pr && pr.catch) pr.catch(()=>{});
      UI.btnReplay.disabled = false;

      UI.choices.innerHTML = '';
      const choices = makeChoices(digits, n);
      choices.forEach(val=>{
        const b = document.createElement('button');
        b.className='choice';
        b.type='button';
        b.textContent=val;
        b.onclick=()=> choose(b, val, n, digits);
        UI.choices.appendChild(b);
      });
    }

    function makeChoices(d, correct){
      let min=0,max=9;
      if(d===1){min=0;max=9}
      else if(d===2){min=10;max=99}
      else if(d===3){min=100;max=999}
      else if(d===4){min=1000;max=9999}
      else if(d===5){min=10000;max=99999}
      const set = new Set([correct]);
      while(set.size<4){ set.add(rnd(min,max)); }
      return shuffle([...set]);
    }

    function choose(btn, picked, correct, digits){
      const st = state[cur.id];
      $$('.choice', UI.choices).forEach(x=>x.disabled=true);
      st.attempts++;

      if(picked===correct){
        btn.classList.add('correct');
        if(!st.completed.includes(correct)){
          st.completed.push(correct);
          st.correctByDigits[digits] = (st.correctByDigits[digits]||0) + 1;
        }
        UI.feedback.innerHTML = '<div class="toastbox text-success">‚úÖ Correct!</div>';
        st.queue.shift();
      }else{
        btn.classList.add('wrong');
        const hit = $$('.choice', UI.choices).find(x=>Number(x.textContent)===correct);
        if(hit) hit.classList.add('correct');
        UI.feedback.innerHTML = '<div class="toastbox text-danger">‚ùå Wrong. Will repeat later.</div>';
        const curQ = st.queue.shift(); st.queue.push(curQ);
      }
      saveAll();

      updateHeader();
      UI.btnNext.disabled = false;
      UI.btnReplay.disabled = false;
    }

    /* --------- Scores & Submissions --------- */
    function levelTag(id){ return LEVELS[id].key; }                 // "Level_1"
    function levelTagWip(id){ return LEVELS[id].key + "_wip"; }     // "Level_1_wip"
    function computeAccuracy(st){ // for checkpoints while in progress
      const done = st.completed.length;
      return Math.max(0, Math.round( (done / Math.max(st.attempts, 1)) * 100 ));
    }
    function computeFinal(st){ // when finished
      const tot = st.total || 1;
      return Math.max(1, Math.round( (tot / Math.max(st.attempts, tot)) * 100 ));
    }

    function submitToForm({name, score, ip, level, checkpoint=false}){
      try{
        const params = new URLSearchParams();
        params.set(FIELD_NAME,  name);
        params.set(FIELD_SCORE, String(score));
        params.set(FIELD_IP,    ip || "unknown");
        params.set(FIELD_LEVEL, checkpoint ? levelTagWip(level) : levelTag(level));

        const body = new Blob([params.toString()], {type:"application/x-www-form-urlencoded;charset=UTF-8"});
        if (navigator.sendBeacon) {
          navigator.sendBeacon(FORM_URL, body);
        } else {
          fetch(FORM_URL, { method:"POST", mode:"no-cors", headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: params.toString() }).catch(()=>{});
        }
      }catch(_){}
    }

    function maybeSubmitCheckpoint(id){
      if(!id) return;
      const st = state[id];
      if(!st) return;
      // only if there was activity and not already submitted this attempt count
      if(st.attempts>0 && st.completed.length < (st.total||Infinity) && st.attempts !== st._lastSubmittedAttempts){
        st._lastSubmittedAttempts = st.attempts;
        const score = computeAccuracy(st);
        submitToForm({ name: profile.name || "Anonymous", score, ip: profile.ip, level:id, checkpoint:true });
        saveAll();
      }
    }

    function renderDone(){
      const st = state[cur.id];
      showPane('done');
      UI.attemptsTotal.textContent = st.attempts;
      const score = computeFinal(st);
      UI.scorePct.textContent = score;

      const parts = [1,2,3,4,5].map(d => st.correctByDigits[d] ? `${d}-digit: <strong>${st.correctByDigits[d]}</strong>` : null).filter(Boolean);
      UI.breakdown.innerHTML = parts.join(' ¬∑ ') || '';

      if(!st.submitted){
        st.submitted = true;
        submitToForm({ name: profile.name || "Anonymous", score, ip: profile.ip, level:cur.id, checkpoint:false });
        saveAll();
      }
    }

    UI.btnAgain.addEventListener('click', ()=>{
      const sel = selectPool(LEVELS[cur.id].spec);
      const st = state[cur.id] = mkEmpty();
      st.queue = sel.queue.map(x=>x.number);
      st.total = sel.intendedTotal;
      st.spec  = LEVELS[cur.id].spec;
      saveAll();
      beginQuiz();
    });

    /* --------- Tabs --------- */
    UI.tabL1.addEventListener('click', ()=> setTab('L1'));
    UI.tabL2.addEventListener('click', ()=> setTab('L2'));
    UI.tabL3.addEventListener('click', ()=> setTab('L3'));

    /* --------- Page lifecycle: checkpoint on hide/reload --------- */
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ maybeSubmitCheckpoint(cur.id); }});
    window.addEventListener('pagehide', ()=>{ maybeSubmitCheckpoint(cur.id); });
    window.addEventListener('beforeunload', ()=>{ maybeSubmitCheckpoint(cur.id); });

    /* --------- Init --------- */
    (function init(){
      if(!Array.isArray(window.MANIFEST)){
        alert('Missing audio/manifest.js (must set window.MANIFEST).');
      }
      if(UI.nameInput.value.trim().length>=2) UI.btnStart.disabled=false;
      setTab('L1');
    })();
  </script>
</body>
</html>
