<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- PHONE: fill screen, no zoom -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1,
                 user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Number Trainer ‚Äî Phone 100% Fit + Auto Submit</title>

  <!-- Bootstrap 5.0.2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">

  <style>
    :root{
      font-size: 18px;  /* balanced phone size */
      --bg:#0b0f16; --card:#0f1523; --ink:#eef2f8; --muted:#a8b3c7; --border:#1e2a3f;
      --ok:#22c55e; --bad:#ef4444; --g1:#5aa8ff; --g2:#7bffca;
      --num-color:#ffd400; /* change to #fff for white numbers */
    }
    *{ -webkit-tap-highlight-color: transparent; }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--ink);
      -webkit-text-size-adjust:100%;
      overscroll-behavior:none;
      touch-action:manipulation;
      user-select:none;
    }

    /* ----- Layout: exactly fills the screen ----- */
    .app{height:100svh; width:100%; display:flex; flex-direction:column;}
    .card-app{
      height:100%; width:100%; display:flex; flex-direction:column;
      border:0; border-radius:0;
      background:
        radial-gradient(950px 650px at -10% -20%, rgba(90,168,255,.12), transparent 40%),
        radial-gradient(900px 600px at 110% -10%, rgba(123,255,202,.10), transparent 40%),
        var(--card);
    }

    /* header */
    .hero{padding:12px 14px calc(8px + env(safe-area-inset-top)); border-bottom:1px solid var(--border);}
    .badge-pill{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.35rem .7rem; border-radius:999px; font-size:.95rem;
      background:#0e1422; border:1px solid #203049; color:#d1d9e7;
    }
    .progress-wrap{height:12px; border-radius:999px; overflow:hidden; background:#0c1220; border:1px solid var(--border);}
    .progress-bar{height:100%; background:linear-gradient(90deg,var(--g1),var(--g2)); transition:width .25s ease;}
    .muted{color:var(--muted);}
    .hidden{display:none !important;}

    /* screens */
    .screen{flex:1 1 auto; display:flex; flex-direction:column; padding:14px; gap:10px; min-height:0;}

    /* Start screen (asks name) */
    .intro h1{font-size:1.35rem; margin:0;}
    .intro p{margin:.2rem 0;}
    .name-box{display:flex; gap:10px; align-items:center;}
    .name-input{
      flex:1;
      background:#0e1626; border:1px solid var(--border); color:var(--ink);
      border-radius:12px; padding:.8rem .9rem; font-size:1.05rem;
    }
    .btn-start{font-size:1.05rem; padding:.9rem 1rem; border-radius:14px;}

    /* Quiz layout uses grid to always fit */
    .quiz-grid{
      flex:1 1 auto; min-height:0;
      display:grid;
      grid-template-rows: auto 1fr auto; /* playbar | choices | cta */
      gap:10px;
    }
    .playbar{display:flex; align-items:center; gap:10px;}
    .btn-play{
      width:72px; height:72px; border-radius:50%;
      background:#0f1729; color:#e8f1ff; border:2px solid #22324f;
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; position:relative; flex:none;
    }
    .btn-play.pulse::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      border:2px solid rgba(90,168,255,.35); animation:pulse 1.6s infinite;
    }
    @keyframes pulse{0%{opacity:.9;transform:scale(.95)}70%{opacity:0;transform:scale(1.18)}100%{opacity:0;transform:scale(1.18)}}
    .btn-fat{font-size:1.05rem; padding:.85rem 1rem; border-radius:14px;}

    /* Choices area fits: 2x2, cells stretch */
    .choices{
      min-height:0;
      display:grid; grid-template-columns:1fr 1fr; grid-auto-rows:1fr; gap:10px;
      align-content:stretch; justify-content:stretch;
    }
    .choice{
      display:flex; align-items:center; justify-content:center;
      border:2px solid #21304a; background:#0d1423; border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      font-weight:900; letter-spacing:.5px; text-align:center;
      color:var(--num-color); text-shadow:0 1px 2px rgba(0,0,0,.85);
      font-size:clamp(2rem, 9.5vw, 3rem);
      padding:8px;
      transition:transform .06s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .choice:active{transform:scale(.985)}
    .choice.correct{border-color:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18) inset;}
    .choice.wrong{border-color:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18) inset;}

    .toastbox{font-size:1rem; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0e1626;}

    /* Sticky CTA sized to thumb & always visible */
    .cta{
      position:sticky; bottom:0; padding-top:6px; background:linear-gradient(180deg,transparent,rgba(11,15,22,.95));
      padding-bottom:calc(6px + env(safe-area-inset-bottom));
    }
    .btn-next{ width:100%; font-size:1.2rem; padding:1rem 1rem; border-radius:16px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card-app">

      <!-- Header -->
      <div class="hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-2">
            <span class="badge-pill" id="pillMode">Ready</span>
            <span class="badge-pill" id="pillCount">Done 0 / 40</span>
          </div>
          <div class="text-end" style="font-size:1rem">
            <div class="muted">Unique Correct: <span id="liveScore">0</span></div>
          </div>
        </div>
        <div class="mt-2 progress-wrap"><div id="bar" class="progress-bar" style="width:0%"></div></div>
      </div>

      <!-- Start -->
      <div class="screen intro" id="screenStart">
        <div class="d-flex flex-column gap-3">
          <div>
            <h1>Number Trainer</h1>
            <p>Hear a number ‚Üí tap the correct one. Solve all <strong>40</strong>. Wrong ones repeat until correct.</p>
          </div>

          <div class="name-box">
            <input id="nameInput" class="name-input" type="text" autocomplete="name"
                   placeholder="Your full name" required>
            <button class="btn btn-primary btn-start" id="btnStart" disabled>Start</button>
          </div>

          <p class="muted small m-0">Tip: your name is saved on this device for next time.</p>
        </div>
      </div>

      <!-- Quiz -->
      <div class="screen hidden" id="screenQuiz">
        <div class="quiz-grid">
          <!-- Playbar -->
          <div class="playbar">
            <button class="btn-play pulse" id="btnPlay" aria-label="Play audio">‚ñ∂Ô∏è</button>
            <button class="btn btn-outline-light btn-fat" id="btnReplay" disabled>‚ü≤ Replay</button>
            <span class="muted ms-auto">Queue: <span id="queueLeft">40</span></span>
          </div>

          <!-- Choices -->
          <div class="choices" id="choices"></div>

          <!-- CTA -->
          <div class="cta">
            <div id="feedback" class="mb-2"></div>
            <button class="btn btn-primary btn-next" id="btnNext" disabled>Next ‚ûú</button>
          </div>
        </div>
        <audio id="player" preload="auto"></audio>
      </div>

      <!-- Done -->
      <div class="screen hidden text-center" id="screenDone">
        <h2 class="h4" style="font-size:1.3rem">Perfect! üéâ</h2>
        <p class="muted" style="font-size:1.05rem">
          All <strong>40</strong> correct. Total attempts: <strong><span id="attemptsTotal">0</span></strong>
        </p>
        <div class="small muted" id="breakdown"></div>
        <div class="mt-2" style="padding-bottom:calc(env(safe-area-inset-bottom) + 6px)">
          <button class="btn btn-success w-100" id="btnRetry">Try Again</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Manifest generated by Python (must define window.MANIFEST) -->
  <script src="audio/manifest.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
          crossorigin="anonymous"></script>

  <script>
    /* ------- Hard-block zoom gestures ------- */
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());
    window.addEventListener('wheel', e => { if (e.ctrlKey) e.preventDefault(); }, { passive:false });

    /* ------- Config: your Google Form field IDs ------- */
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf_bAuHT1RQI_4gnRWyYrveE9XDccSaddRkxLaFSz9YLziTMQ/formResponse";
    const FIELD_NAME  = "entry.1894172247"; // name
    const FIELD_SCORE = "entry.18818728";   // score (number)
    const FIELD_IP    = "entry.361885690";  // IP

    /* ------- Small helpers ------- */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const shuffle = (a)=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };
    const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    /* ------- UI refs ------- */
    const UI = {
      start: $('#screenStart'), quiz: $('#screenQuiz'), done: $('#screenDone'),
      nameInput: $('#nameInput'), btnStart: $('#btnStart'),
      btnPlay: $('#btnPlay'), btnReplay: $('#btnReplay'), btnNext: $('#btnNext'), btnRetry: $('#btnRetry'),
      player: $('#player'), choices: $('#choices'), feedback: $('#feedback'),
      pillMode: $('#pillMode'), pillCount: $('#pillCount'), queueLeft: $('#queueLeft'),
      liveScore: $('#liveScore'), bar: $('#bar'),
      attemptsTotal: $('#attemptsTotal'), breakdown: $('#breakdown')
    };

    const TOTAL_UNIQUE = 40;
    const TARGET_COUNTS = {2:15, 3:15, 5:10};

    /* ------- State ------- */
    const state = {
      queue: [],
      completed: new Set(),
      correctByDigits: {2:0,3:0,5:0},
      attempts: 0,
      studentName: "",
      ip: "unknown",
      submitted: false
    };

    /* ------- IP fetch (public IP) ------- */
    (function fetchIP(){
      fetch("https://api.ipify.org?format=json", {cache:"no-store"})
        .then(r=>r.json())
        .then(d=> state.ip = d.ip)
        .catch(()=> state.ip = "unknown");
    })();

    /* ------- Start screen name handling ------- */
    // preload from localStorage
    const savedName = localStorage.getItem("numtrainer_name") || "";
    if (savedName) {
      UI.nameInput.value = savedName;
      UI.btnStart.disabled = savedName.trim().length < 2;
    }
    UI.nameInput.addEventListener("input", () => {
      UI.btnStart.disabled = UI.nameInput.value.trim().length < 2;
    });

    function setScreen(name){
      UI.start.classList.toggle('hidden', name!=='start');
      UI.quiz.classList.toggle('hidden', name!=='quiz');
      UI.done.classList.toggle('hidden', name!=='done');
    }

    function validateManifest(list){
      const c2 = list.filter(x=>x.digits===2).length;
      const c3 = list.filter(x=>x.digits===3).length;
      const c5 = list.filter(x=>x.digits===5).length;
      if(c2!==TARGET_COUNTS[2] || c3!==TARGET_COUNTS[3] || c5!==TARGET_COUNTS[5]){
        alert(`Manifest counts invalid (2:${c2}, 3:${c3}, 5:${c5}). Rerun generator.`);
        throw new Error('Bad manifest');
      }
    }

    function pctDone(){ return Math.round((state.completed.size / TOTAL_UNIQUE) * 100); }

    function makeChoices(q){
      const d=q.digits; let min,max;
      if(d===2){min=10;max=99} else if(d===3){min=100;max=999} else {min=10000;max=99999}
      const set=new Set([q.number]); while(set.size<4) set.add(rnd(min,max));
      const arr=[...set];
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    function renderQuestion(){
      if(state.queue.length===0) return finish();

      const q = state.queue[0];

      UI.pillMode.textContent = `${q.digits}-digit`;
      UI.pillCount.textContent = `Done ${state.completed.size} / ${TOTAL_UNIQUE}`;
      UI.queueLeft.textContent = state.queue.length;
      UI.bar.style.width = `${pctDone()}%`;
      UI.feedback.innerHTML = '';
      UI.btnNext.disabled = true; UI.btnReplay.disabled = true;

      UI.player.src = q.file;
      const p = UI.player.play(); if(p && p.catch) p.catch(()=>{});
      UI.btnReplay.disabled = false;

      const nums = makeChoices(q);
      UI.choices.innerHTML = '';
      nums.forEach(n=>{
        const b=document.createElement('button');
        b.className='choice';
        b.type='button';
        b.textContent=n;
        b.onclick=()=>choose(b, n, q.number, q.digits);
        UI.choices.appendChild(b);
      });
    }

    function choose(btn, picked, correct, digits){
      $$('.choice', UI.choices).forEach(x=>x.disabled=true);
      state.attempts++;

      if(picked===correct){
        btn.classList.add('correct');
        if(!state.completed.has(correct)){
          state.completed.add(correct);
          state.correctByDigits[digits] = (state.correctByDigits[digits]||0)+1;
        }
        UI.feedback.innerHTML = '<div class="toastbox text-success">‚úÖ Correct!</div>';
        state.queue.shift(); // remove
      } else {
        btn.classList.add('wrong');
        const hit = $$('.choice', UI.choices).find(x=>Number(x.textContent)===correct);
        if(hit) hit.classList.add('correct');
        UI.feedback.innerHTML = `<div class="toastbox text-danger">‚ùå Wrong. Will repeat later.</div>`;
        const cur = state.queue.shift(); state.queue.push(cur); // move to end
      }

      UI.liveScore.textContent = state.completed.size;
      UI.pillCount.textContent = `Done ${state.completed.size} / ${TOTAL_UNIQUE}`;
      UI.queueLeft.textContent = state.queue.length;
      UI.bar.style.width = `${pctDone()}%`;

      UI.btnNext.disabled = false;
      UI.btnReplay.disabled = false;
    }

    function nextQuestion(){
      if(state.completed.size>=TOTAL_UNIQUE) return finish();
      renderQuestion();
    }

    function finish(){
      setScreen('done');
      UI.attemptsTotal.textContent = state.attempts;
      const b2 = `2-digit correct: <strong>${state.correctByDigits[2]||0}</strong> / ${TARGET_COUNTS[2]}`;
      const b3 = `3-digit correct: <strong>${state.correctByDigits[3]||0}</strong> / ${TARGET_COUNTS[3]}`;
      const b5 = `5-digit correct: <strong>${state.correctByDigits[5]||0}</strong> / ${TARGET_COUNTS[5]}`;
      UI.breakdown.innerHTML = `${b2} &nbsp;‚Ä¢&nbsp; ${b3} &nbsp;‚Ä¢&nbsp; ${b5}`;
      UI.bar.style.width = '100%';

      // ---- AUTO SUBMIT (silent) ----
      if (!state.submitted) {
        state.submitted = true;
        const scorePercent = Math.max(1, Math.round((TOTAL_UNIQUE / Math.max(state.attempts, TOTAL_UNIQUE)) * 100));
        // Save & send
        try {
          const fd = new FormData();
          fd.append(FIELD_NAME,  state.studentName);
          fd.append(FIELD_SCORE, String(scorePercent));
          fd.append(FIELD_IP,    state.ip || "unknown");
          fetch(FORM_URL, { method: "POST", mode: "no-cors", body: fd })
            .catch(()=>{}); // silent by design
        } catch(_) {}
      }
    }

    function startQuiz(){
      // name gate
      const name = UI.nameInput.value.trim();
      if (name.length < 2) return;
      state.studentName = name;
      localStorage.setItem("numtrainer_name", name);

      if(!Array.isArray(window.MANIFEST)){
        alert('Missing audio/manifest.js (must set window.MANIFEST). Run generate_audio.py.');
        return;
      }
      validateManifest(MANIFEST);
      state.queue = shuffle([...MANIFEST]); // all 40
      state.completed.clear();
      state.correctByDigits = {2:0,3:0,5:0};
      state.attempts = 0;
      state.submitted = false;

      UI.liveScore.textContent = '0';
      UI.pillCount.textContent = 'Done 0 / 40';
      UI.queueLeft.textContent = state.queue.length;
      UI.bar.style.width = '0%';

      setScreen('quiz');
      renderQuestion();
    }

    // events
    UI.btnStart.addEventListener('click', startQuiz);
    UI.btnPlay.addEventListener('click', ()=>{ UI.player.currentTime=0; UI.player.play().catch(()=>{}); UI.btnReplay.disabled=false; });
    UI.btnReplay.addEventListener('click', ()=>{ UI.player.currentTime=0; UI.player.play().catch(()=>{}); });
    UI.btnNext.addEventListener('click', nextQuestion);
    UI.btnRetry?.addEventListener('click', ()=> setScreen('start'));
  </script>
</body>
</html>
